title: みんなのPython Webアプリ編 - ユニコードと日本語処理
date: 2014-09-03 15:00
fmt: markdown
prev : /ats/stuff/minpy_web/02/03.html
prev_title: Pythonのオブジェクト指向機能
next : /ats/stuff/minpy_web/03/index.html
next_title: PythonでWebサーバを作る

### ユニコードと日本語処理

前述のとおり、Python 2には2種類の文字列型があります。1つは文字列型、もう1つはユニコード型です。日本語のようなマルチバイト文字列をPythonで扱う場合には、ユニコード型を使うとよいでしょう。

Pythonにはコデックス(codecs)と呼ばれる仕組みがあります。コデックスを使うと、ユニコードと他エンコードで相互に変換ができます。ユニコード文字列からEUC-JPなどの8ビット文字列への変換もできますし、逆にシフトJIS相当などの8ビット文字列からユニコード文字列への変換を行うこともできます。

#### ユニコード型と文字列の境界

ユニコード型の一番の利点は、マルチバイト文字列の文字の区切りを容易に扱えるということです。ASCII文字列でも日本語のマルチバイト文字列でも、1文字ずつ区切って扱うことができます。ユニコード文字列もシーケンス型の一種ですので、インデックス指定やスライスを使って文字列の一部を取り出すことができます。以下に簡単な例を示します。

** ユニコード型の使用例 **

    :::python
    >>> u=u"あいうabc"      # ユニコード文字列を変数に代入
    >>> print u[2]         # 3番目の文字を取り出す
    う
    >>> print u[1:4] いうa  # 2番目から4番目までの文字列を取り出す

同じことを、ユニコード相当の8ビット文字列で行うとどうなるでしょうか。

** 文字列型の使用例 **

    :::python
    >>> ru="あいうabc"
    >>> print ru[2]
    >>> print ru[1:4]
    ・い

先の例と同じく2番目に当たる文字列を取得しようとすると、バイト列で見たときの3番目の文字列、ユニコードの内部表現「あ」の3バイト目である文字コード130(16進数で82)に相当する文字列が返ってきます。

このように、8ビット文字列にインデックスを与えても、マルチバイト文字列の文字の区切りを正しく扱えないのです。マルチバイト文字列を簡易に正しく扱いたい場合は、コード内部でユニコード文字列を使うと処理が簡潔に書けます。

#### 他のエンコードからユニコード文字列への変換

Webからの入力や、Eメールの本文などはユニコード以外のエンコードで送られてくることがあります。そのような場合には、文字列をユニコード文字列に変換しておくと便利です。

特定のエンコードを持った8ビット文字列からユニコード文字列に変換するには、2つの方法があります。ここでは、unicode()関数を使った方法を紹介します。

** unicode()関数の使用例: **

    :::python
    u=unicode('あいう', 'euc-jp', 'replace')

第1引数に変換対象となる8ビット文字列を、第2引数に文字列のエンコードを渡します。すると、ユニコード文字列が戻り値として返ってきます。第3引数はオブションで、変換中に起こったエラーに対する対処を指定します。ここでは、変換不能な文字列があった場合には特定の文字列に置き換えるように指定しています。

なお、次のdecode()メソッドを使っても、特定のエンコードをユニコード文字列に変換できます。

#### ユニコード文字列から他エンコードへの変換

** decode()メソッドの使用例: **

    :::python
    u=u"あいう"
    u.decode('iso-2022-jp', 'ignore')

ユニコード文字列を他のエンコードに変換したい場合には、ユニコード文字列に対してdecode()メソッドを使います。メソッド呼び出しを行っているユニコード文字列が処理の対象になるので、第1引数は変換したいエンコード名となります。第2引数は、変換エラーが起こったときの対処を指示します。この例では、変換エラーが起こった文字列をそのまま残すように指示しています。

#### プログラム内部での日本語の扱い

Pythonのプログラムでは、内部でユニコードを使い、必要に応じてエンコードを変換するようにします。最近のWebアプリであれば，プログラム内部のユニコード文字列を使い、Webアプリケーションの出力時にUTF-8に変換をするとよいでしょう。



